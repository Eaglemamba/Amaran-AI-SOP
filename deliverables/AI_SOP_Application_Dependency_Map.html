<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI SOP Application Dependency Map v5</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap');
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:'Poppins','Noto Sans TC',sans-serif;background:#0f0e17;color:#e8e8e8;height:100vh;overflow:hidden}
  .container{display:flex;height:100vh;width:100vw}
  .graph-area{flex:1;min-width:0;display:flex;flex-direction:column;overflow:hidden}
  .side-panel{width:285px;min-width:285px;background:#16152a;border-left:1px solid #2a2a42;display:flex;flex-direction:column;overflow-y:auto}
  .header{padding:0.6rem 1rem 0.2rem}
  .header h1{font-size:1rem;font-weight:700;color:#fff;letter-spacing:-0.02em}
  .header h1 span{color:#a78bfa}
  .header p{font-size:0.63rem;color:#7f7f9a;margin-top:0.08rem;line-height:1.4}
  .legend{display:flex;gap:0.55rem;padding:0.05rem 1rem 0.15rem;flex-wrap:wrap}
  .legend-item{display:flex;align-items:center;gap:0.2rem;font-size:0.55rem;color:#7f7f9a}
  .legend-dot{width:6px;height:6px;border-radius:50%}
  .legend-pill{width:12px;height:6px;border-radius:3px;border:1.2px solid #f59e0b;background:transparent}
  .legend-diamond{width:7px;height:7px;border:1.2px solid #818cf8;background:transparent;transform:rotate(45deg)}
  .svg-wrap{flex:1;padding:0 0.2rem 0.2rem;overflow:hidden}
  svg.dep-svg{width:100%;height:100%}
  .node-group{cursor:pointer}
  .node-bg{transition:all 0.2s;stroke-width:1.2}
  .node-group:hover .node-bg,.node-group.active .node-bg{filter:drop-shadow(0 0 7px rgba(167,139,250,0.35));stroke-width:2}
  .node-group.dimmed .node-bg{opacity:0.08}
  .node-group.dimmed text{opacity:0.08}
  .node-label{font-family:'Poppins','Noto Sans TC',sans-serif;font-weight:600;font-size:7.5px;fill:#fff;text-anchor:middle;pointer-events:none}
  .node-sublabel{font-family:'Poppins','Noto Sans TC',sans-serif;font-weight:400;font-size:5.8px;fill:#b0b0c8;text-anchor:middle;pointer-events:none}
  .node-phase{font-family:'Poppins',sans-serif;font-weight:700;font-size:5.2px;text-anchor:middle;pointer-events:none}
  .infra-label{font-family:'Poppins','Noto Sans TC',sans-serif;font-weight:600;font-size:6.8px;fill:#fbbf24;text-anchor:middle;pointer-events:none}
  .infra-sublabel{font-family:'Poppins','Noto Sans TC',sans-serif;font-weight:400;font-size:5.2px;fill:#a08a50;text-anchor:middle;pointer-events:none}
  .gate-label{font-family:'Poppins','Noto Sans TC',sans-serif;font-weight:600;font-size:6.2px;fill:#a5b4fc;text-anchor:middle;pointer-events:none}
  .gate-sublabel{font-family:'Poppins','Noto Sans TC',sans-serif;font-weight:400;font-size:5.2px;fill:#6366a0;text-anchor:middle;pointer-events:none}
  .edge{stroke-width:1;fill:none;opacity:0.13;transition:opacity 0.2s,stroke-width 0.2s}
  .edge.highlighted{opacity:0.7;stroke-width:1.8}
  .edge.dimmed{opacity:0.015}
  .edge-infra{stroke-dasharray:4 2.5}
  .edge-gate{stroke-dasharray:2 2}
  .tier-label{font-family:'Poppins',sans-serif;font-weight:700;font-size:6px;fill:#222240;text-anchor:start;letter-spacing:1px;text-transform:uppercase}
  .tier-line{stroke:#151530;stroke-width:0.5;stroke-dasharray:3 3}
  .panel-empty{flex:1;display:flex;align-items:center;justify-content:center;padding:1.5rem}
  .panel-empty p{font-size:0.73rem;color:#3a3a55;text-align:center;line-height:1.7}
  .panel-content{display:none;flex-direction:column}
  .panel-content.visible{display:flex}
  .panel-header{padding:0.8rem 0.9rem 0.5rem;border-bottom:1px solid #2a2a42}
  .panel-phase{font-size:0.58rem;font-weight:700;letter-spacing:1px;margin-bottom:0.12rem}
  .panel-title{font-size:0.85rem;font-weight:700;color:#fff;line-height:1.3}
  .panel-zh{font-size:0.72rem;color:#9a9ab0;margin-top:0.08rem}
  .panel-dept{font-size:0.62rem;color:#5a5a7a;margin-top:0.15rem}
  .panel-type{display:inline-block;font-size:0.53rem;font-weight:700;padding:0.1rem 0.4rem;border-radius:10px;margin-top:0.25rem;letter-spacing:0.5px}
  .type-app{background:#1e1e36;color:#a78bfa;border:1px solid #a78bfa}
  .type-infra{background:#2a2210;color:#f59e0b;border:1px solid #f59e0b}
  .type-gate{background:#1e1e36;color:#818cf8;border:1px solid #818cf8}
  .panel-desc{padding:0.4rem 0.9rem;font-size:0.68rem;color:#8888a8;line-height:1.5}
  .panel-section{padding:0.45rem 0.9rem}
  .panel-section h4{font-size:0.56rem;text-transform:uppercase;letter-spacing:1px;color:#5a5a7a;margin-bottom:0.2rem}
  .panel-list{list-style:none;padding:0}
  .panel-list li{font-size:0.68rem;color:#c0c0d8;padding:0.12rem 0;display:flex;align-items:center;gap:0.25rem}
  .panel-list li .dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
  .panel-list-none{font-size:0.66rem;color:#3a3a55;font-style:italic}
  .panel-divider{height:1px;background:#2a2a42;margin:0 0.9rem}
  .impact-row{display:flex;gap:0.3rem;padding:0.4rem 0.6rem}
  .impact-num{text-align:center;flex:1;padding:0.3rem 0.1rem;background:#1e1e36;border-radius:6px}
  .impact-num .num{font-size:1.05rem;font-weight:700;color:#a78bfa}
  .impact-num .lbl{font-size:0.48rem;color:#5a5a7a;margin-top:0.04rem}
  @media(max-width:768px){.container{flex-direction:column}.side-panel{width:100%;min-width:100%;height:260px;border-left:none;border-top:1px solid #2a2a42}}
</style>
</head>
<body>
<div class="container">
  <div class="graph-area">
    <div class="header">
      <h1>AI SOP Knowledge Retrieval <span>Dependency Map</span></h1>
      <p>16 apps + 6 supporting deliverables. CCS is upstream reference framework for CC Impact Assessment.</p>
    </div>
    <div class="legend">
      <div class="legend-item"><div class="legend-dot" style="background:#34d399"></div>P1</div>
      <div class="legend-item"><div class="legend-dot" style="background:#60a5fa"></div>P2</div>
      <div class="legend-item"><div class="legend-dot" style="background:#a78bfa"></div>P3</div>
      <div class="legend-item"><div class="legend-dot" style="background:#6b7280"></div>Future</div>
      <div class="legend-item"><div class="legend-pill"></div>Infrastructure</div>
      <div class="legend-item"><div class="legend-diamond"></div>Decision Gate</div>
    </div>
    <div class="svg-wrap">
      <svg class="dep-svg" viewBox="0 0 960 810" preserveAspectRatio="xMidYMid meet">
        <defs>
          <marker id="arr-g" markerWidth="5" markerHeight="4" refX="5" refY="2" orient="auto"><polygon points="0 0,5 2,0 4" fill="#34d399"/></marker>
          <marker id="arr-b" markerWidth="5" markerHeight="4" refX="5" refY="2" orient="auto"><polygon points="0 0,5 2,0 4" fill="#60a5fa"/></marker>
          <marker id="arr-p" markerWidth="5" markerHeight="4" refX="5" refY="2" orient="auto"><polygon points="0 0,5 2,0 4" fill="#a78bfa"/></marker>
          <marker id="arr-x" markerWidth="5" markerHeight="4" refX="5" refY="2" orient="auto"><polygon points="0 0,5 2,0 4" fill="#6b7280"/></marker>
          <marker id="arr-i" markerWidth="5" markerHeight="4" refX="5" refY="2" orient="auto"><polygon points="0 0,5 2,0 4" fill="#f59e0b"/></marker>
          <marker id="arr-d" markerWidth="5" markerHeight="4" refX="5" refY="2" orient="auto"><polygon points="0 0,5 2,0 4" fill="#818cf8"/></marker>
        </defs>
        <!-- Tier lines: 8 tiers -->
        <text class="tier-label" x="5" y="27">INFRA (P0)</text>
        <line class="tier-line" x1="72" y1="23" x2="950" y2="23"/>
        <text class="tier-label" x="5" y="97">FOUNDATION</text>
        <line class="tier-line" x1="75" y1="93" x2="950" y2="93"/>
        <text class="tier-label" x="5" y="177">TIER 1</text>
        <line class="tier-line" x1="40" y1="173" x2="950" y2="173"/>
        <text class="tier-label" x="5" y="277">TIER 2</text>
        <line class="tier-line" x1="40" y1="273" x2="950" y2="273"/>
        <text class="tier-label" x="5" y="377">TIER 3</text>
        <line class="tier-line" x1="40" y1="373" x2="950" y2="373"/>
        <text class="tier-label" x="5" y="477">TIER 4</text>
        <line class="tier-line" x1="40" y1="473" x2="950" y2="473"/>
        <text class="tier-label" x="5" y="577">TIER 5</text>
        <line class="tier-line" x1="40" y1="573" x2="950" y2="573"/>
        <text class="tier-label" x="5" y="677">TIER 6</text>
        <line class="tier-line" x1="40" y1="673" x2="950" y2="673"/>
        <text class="tier-label" x="5" y="757">TIER 7</text>
        <line class="tier-line" x1="40" y1="753" x2="950" y2="753"/>
        <g id="edges"></g>
        <g id="nodes"></g>
      </svg>
    </div>
  </div>
  <div class="side-panel">
    <div class="panel-empty" id="panelEmpty">
      <p>Click a node to see upstream dependencies, downstream impact, and total reach.</p>
    </div>
    <div class="panel-content" id="panelContent">
      <div class="panel-header">
        <div class="panel-phase" id="panelPhase"></div>
        <div class="panel-title" id="panelTitle"></div>
        <div class="panel-zh" id="panelZh"></div>
        <div class="panel-dept" id="panelDept"></div>
        <div class="panel-type" id="panelType"></div>
      </div>
      <div class="panel-desc" id="panelDesc"></div>
      <div class="impact-row">
        <div class="impact-num"><div class="num" id="upCount">0</div><div class="lbl">Upstream</div></div>
        <div class="impact-num"><div class="num" id="downCount">0</div><div class="lbl">Direct Down</div></div>
        <div class="impact-num"><div class="num" id="totalCount">0</div><div class="lbl">Total Reach</div></div>
      </div>
      <div class="panel-divider"></div>
      <div class="panel-section">
        <h4>Upstream Dependencies</h4>
        <ul class="panel-list" id="upList"></ul>
      </div>
      <div class="panel-divider"></div>
      <div class="panel-section">
        <h4>Downstream Impact</h4>
        <ul class="panel-list" id="downList"></ul>
      </div>
    </div>
  </div>
</div>
<script>
// ═══ 22 NODES ═══
// Key change: CCS promoted to Tier 2 (P2), upstream of CC Full Matrix
const NODES=[
  // ── INFRA (P0) ──
  {id:'desensitize',label:'Desensitization Script',label2:'去敏化腳本 + QA 驗證',dept:'Operations + QA',phase:'P0',color:'#f59e0b',x:180,y:52,type:'infra',
   desc:'Python script to strip client names, product codes, batch numbers, pricing. QA verifies zero leakage. Hard blocker for any SOP upload.'},
  {id:'test_suite',label:'Acceptance Test Suite',label2:'驗收測試案例集',dept:'Operations + QA',phase:'P0',color:'#f59e0b',x:480,y:52,type:'infra',
   desc:'10-15 queries with known correct answers. Run at each phase gate. Track: context relevance, groundedness, answer relevance (RAG Triad).'},
  {id:'ai_policy',label:'AI Use Policy + Inventory',label2:'AI 使用政策 + 系統清冊',dept:'QA',phase:'P0',color:'#f59e0b',x:780,y:52,type:'infra',
   desc:'Add to computerized system inventory. 1-page policy: acceptable use, human oversight, data protection. Extends existing QMS.'},

  // ── FOUNDATION ──
  {id:'sop_search',label:'SOP Content Search',label2:'SOP 內容搜尋',dept:'All Depts',phase:'P1',color:'#34d399',x:480,y:127,type:'app',
   desc:'Core search engine. Word/PDF to Markdown, upload to Claude Project / Gemini. This IS the POC. Critical path for everything.'},

  // ── TIER 1 (P1 Quick Wins) ──
  {id:'cc_basic',label:'CC Impact (Basic)',label2:'變更管控 -- 基礎版',dept:'QA / Operations',phase:'P1',color:'#34d399',x:120,y:212,type:'app',
   desc:'"Which SOPs mention [topic]?" Prompt engineering on existing SOP knowledge base. 70% of CC value with 20% of effort.'},
  {id:'reg_gap',label:'Regulatory Gap Analysis',label2:'法規 SOP 差異分析',dept:'RA / QA',phase:'P1',color:'#34d399',x:370,y:212,type:'app',
   desc:'Upload regulatory text alongside SOPs. "Which SOPs don\'t meet PIC/S Annex 1 Section X?" Same engine, different query.'},
  {id:'training',label:'New Employee Training',label2:'新人教育訓練',dept:'HR / All Depts',phase:'P1',color:'#34d399',x:600,y:212,type:'app',
   desc:'Training assistant: explain procedures, quiz SOP content, answer new hire questions. System prompt only.'},
  {id:'equip_doc',label:'Equipment Doc Search',label2:'設備文件搜尋',dept:'Engineering',phase:'P2',color:'#60a5fa',x:830,y:212,type:'app',
   desc:'Ingest equipment manuals, IQ/OQ/PQ, maintenance SOPs. Expand conversion pipeline for equipment formats.'},

  // ── TIER 2 (P2 Expand) -- CCS NOW HERE ──
  {id:'deviation',label:'Deviation Investigation',label2:'偏差調查參考',dept:'QA / MFG',phase:'P2',color:'#60a5fa',x:110,y:315,type:'app',
   desc:'"Show similar deviations and root causes." Add deviation/CAPA records. Heavier desensitization (batch-specific data).'},
  {id:'val_xref',label:'Validation Cross-Ref',label2:'驗證文件交叉引用',dept:'QA / Validation',phase:'P2',color:'#60a5fa',x:335,y:315,type:'app',
   desc:'"Which validation protocols reference this equipment SOP?" Revalidation triggers from change controls.'},
  {id:'ccs',label:'Contamination Control',label2:'污染控制策略 (CCS)',dept:'QA / MFG / Eng',phase:'P2',color:'#60a5fa',x:560,y:315,type:'app',
   desc:'Cross-reference cleaning SOPs, EM procedures, gowning against PIC/S Annex 1 CCS requirements. Builds the contamination risk-control mapping. Serves as UPSTREAM REFERENCE for every CC impact assessment -- "Does this change affect a contamination control element?"'},
  {id:'audit_prep',label:'Customer Audit Prep',label2:'客戶稽核準備',dept:'QA',phase:'P2',color:'#60a5fa',x:785,y:315,type:'app',
   desc:'Combine SOP + validation + training + gap analysis into audit readiness queries. Mostly prompt engineering.'},

  // ── TIER 3 ──
  {id:'bd_qa',label:'BD Client Technical Q&A',label2:'BD 客戶技術回覆',dept:'BD / Operations',phase:'P2',color:'#60a5fa',x:110,y:415,type:'app',
   desc:'BD-facing query interface. May need separate restricted knowledge base for external sharing.'},
  {id:'cc_full',label:'CC Impact (Full Matrix)',label2:'變更管控 -- 進階版',dept:'QA / All Depts',phase:'P3',color:'#a78bfa',x:340,y:415,type:'app',
   desc:'Structured dependency graphs: equipment-SOP mappings, material-supplier links, AND CCS element mapping. Every CC initiation queries: "Which CCS controls does this change touch?" Institutional knowledge extraction. 6-8 weeks.'},
  {id:'tech_transfer',label:'Tech Transfer Knowledge',label2:'技術轉移知識庫',dept:'Operations / PM',phase:'P3',color:'#a78bfa',x:560,y:415,type:'app',
   desc:'Consolidate validation + training + process SOPs for tech transfer. High value for new client onboarding.'},
  {id:'dev_report',label:'Deviation Report Gen',label2:'偏差報告自動生成',dept:'QA / MFG',phase:'P3',color:'#a78bfa',x:785,y:415,type:'app',
   desc:'[[Placeholder]] methodology. AI drafts investigation narrative from past deviations. Same architecture as Campaign Report Generator.'},

  // ── INFRA: P2 governance ──
  {id:'risk_cc',label:'Risk Assessment + CC Proc',label2:'風險評估 + 變更管控',dept:'QA',phase:'P2',color:'#f59e0b',x:910,y:365,type:'infra',
   desc:'Simple risk assessment (human verifies = low risk). CC tiers: minor (prompt), moderate (new fields), major (model upgrade). Enables team-wide rollout.'},

  // ── TIER 4 ──
  {id:'apqr',label:'APQR Data Aggregation',label2:'年度品質回顧彙整',dept:'QA',phase:'P3',color:'#a78bfa',x:240,y:515,type:'app',
   desc:'Pull deviation trends, CC history, CCS gap findings, audit results into APQR summaries. Requires mature Phase 1-2 data.'},
  {id:'meeting',label:'Meeting Minutes Search',label2:'會議記錄搜尋',dept:'All Depts',phase:'P3',color:'#a78bfa',x:540,y:515,type:'app',
   desc:'Ingest meeting minutes. Low tech, high change management (need standardized format).'},

  // ── DECISION GATE ──
  {id:'arch_gate',label:'Architecture Decision Gate',label2:'架構決策：Context vs Vector DB',dept:'Operations',phase:'P2/3',color:'#818cf8',x:810,y:515,type:'gate',
   desc:'Evaluate: >500 docs? Multi-user? Accuracy degrading? If yes, plan Chroma + embeddings migration. Otherwise stay Markdown + LLM.'},

  // ── INFRA: P3 governance ──
  {id:'val_review',label:'Validation Summary + Review',label2:'驗證總結 + 定期回顧',dept:'QA',phase:'P3',color:'#f59e0b',x:540,y:610,type:'infra',
   desc:'Summarize all testing. Quarterly review: accuracy trends, incidents, user feedback. Supplier assessment for Anthropic/Google APIs.'},

  // ── TIER 7 (Future) ──
  {id:'cust_bot',label:'Customer Service Bot',label2:'客戶服務機器人',dept:'BD / CS',phase:'FT',color:'#6b7280',x:480,y:785,type:'app',
   desc:'External-facing chatbot. IT security, legal approval, separate infra. Needs formal governance (possibly full GAMP).'},
];

// ═══ EDGES ═══
const EDGES=[
  // Infra P0 -> Foundation
  ['desensitize','sop_search'],['test_suite','sop_search'],['ai_policy','sop_search'],

  // Foundation -> Tier 1
  ['sop_search','cc_basic'],['sop_search','reg_gap'],['sop_search','training'],['sop_search','equip_doc'],
  // Foundation -> deeper
  ['sop_search','deviation'],['sop_search','val_xref'],['sop_search','meeting'],
  ['sop_search','ccs'],['sop_search','dev_report'],

  // Tier 1 cross + down
  ['reg_gap','cc_basic'],['reg_gap','audit_prep'],
  ['reg_gap','ccs'],           // Regulatory requirements drive CCS
  ['cc_basic','deviation'],['cc_basic','val_xref'],
  ['cc_basic','cc_full'],      // Basic CC evolves into Full
  ['training','audit_prep'],['training','tech_transfer'],
  ['equip_doc','val_xref'],['equip_doc','ccs'],  // Equipment docs for facility design in CCS

  // ══ KEY CHANGE: CCS is upstream of CC Full ══
  ['ccs','cc_full'],           // CCS reference framework feeds every CC impact assessment
  ['ccs','apqr'],             // CCS gap findings feed APQR
  ['ccs','dev_report'],       // Deviation reports reference CCS controls

  // Tier 2 -> down
  ['deviation','bd_qa'],['deviation','apqr'],['deviation','dev_report'],
  ['deviation','cc_full'],     // Deviation history feeds CC matrix
  ['deviation','ccs'],         // Deviation data identifies contamination risks
  ['val_xref','audit_prep'],['val_xref','tech_transfer'],['val_xref','cc_full'],
  ['audit_prep','bd_qa'],['audit_prep','apqr'],
  ['equip_doc','cc_full'],     // Equipment mappings in CC matrix

  // Infra P2: Risk Assessment
  ['ai_policy','risk_cc'],
  ['risk_cc','cc_full'],['risk_cc','tech_transfer'],['risk_cc','dev_report'],

  // Test suite gates
  ['test_suite','cc_basic'],['test_suite','equip_doc'],['test_suite','arch_gate'],

  // Tier 3 -> Tier 4
  ['cc_full','apqr'],['tech_transfer','apqr'],

  // Architecture gate
  ['arch_gate','val_review'],

  // Validation review
  ['apqr','val_review'],['risk_cc','val_review'],

  // -> Future
  ['bd_qa','cust_bot'],['tech_transfer','cust_bot'],['cc_full','cust_bot'],
  ['val_review','cust_bot'],
];

// ═══ ENGINE ═══
const nodeMap={};NODES.forEach(n=>nodeMap[n.id]=n);
const downstream={},upstream={};
NODES.forEach(n=>{downstream[n.id]=[];upstream[n.id]=[]});
EDGES.forEach(([f,t])=>{downstream[f].push(t);upstream[t].push(f)});
function totalReach(id,v=new Set()){downstream[id].forEach(d=>{if(!v.has(d)){v.add(d);totalReach(d,v)}});return v.size}

const svgNS='http://www.w3.org/2000/svg';
const edgesG=document.getElementById('edges'),nodesG=document.getElementById('nodes');
const edgeEls=[];

EDGES.forEach(([fid,tid])=>{
  const f=nodeMap[fid],t=nodeMap[tid];
  const dx=t.x-f.x,dy=t.y-f.y,dist=Math.sqrt(dx*dx+dy*dy)||1;
  const fR=f.type==='app'?50:36, tR=t.type==='app'?50:36;
  const fH=f.type==='app'?19:12, tH=t.type==='app'?19:12;
  const sx=f.x+(dx/dist)*fR,sy=f.y+(dy/dist)*fH;
  const ex=t.x-(dx/dist)*tR,ey=t.y-(dy/dist)*tH;
  const mx=(sx+ex)/2,my=(sy+ey)/2;
  const cx=mx+(ey-sy)*0.055,cy=my-(ex-sx)*0.055;
  const isInfra=f.type==='infra'||t.type==='infra';
  const isGate=f.type==='gate'||t.type==='gate';
  const aid=isInfra?'arr-i':isGate?'arr-d':f.color==='#34d399'?'arr-g':f.color==='#60a5fa'?'arr-b':f.color==='#a78bfa'?'arr-p':'arr-x';
  const p=document.createElementNS(svgNS,'path');
  p.setAttribute('d',`M${sx},${sy} Q${cx},${cy} ${ex},${ey}`);
  p.setAttribute('stroke',isInfra?'#f59e0b':isGate?'#818cf8':f.color);
  p.setAttribute('marker-end',`url(#${aid})`);
  p.classList.add('edge');
  if(isInfra)p.classList.add('edge-infra');
  if(isGate)p.classList.add('edge-gate');
  p.dataset.from=fid;p.dataset.to=tid;
  edgesG.appendChild(p);edgeEls.push(p);
});

const nodeEls={};
NODES.forEach(n=>{
  const g=document.createElementNS(svgNS,'g');g.classList.add('node-group');g.dataset.id=n.id;
  if(n.type==='infra'){
    const w=118,h=25;
    const r=document.createElementNS(svgNS,'rect');
    r.setAttribute('x',n.x-w/2);r.setAttribute('y',n.y-h/2);
    r.setAttribute('width',w);r.setAttribute('height',h);
    r.setAttribute('rx',13);r.setAttribute('ry',13);
    r.setAttribute('fill','#1e1a10');r.setAttribute('stroke','#f59e0b');
    r.classList.add('node-bg');g.appendChild(r);
    const lb=document.createElementNS(svgNS,'text');
    lb.setAttribute('x',n.x);lb.setAttribute('y',n.y-0.5);
    lb.classList.add('infra-label');lb.textContent=n.label;g.appendChild(lb);
    const sb=document.createElementNS(svgNS,'text');
    sb.setAttribute('x',n.x);sb.setAttribute('y',n.y+9);
    sb.classList.add('infra-sublabel');sb.textContent=n.label2;g.appendChild(sb);
  } else if(n.type==='gate'){
    const w=118,h=25;
    const r=document.createElementNS(svgNS,'rect');
    r.setAttribute('x',n.x-w/2);r.setAttribute('y',n.y-h/2);
    r.setAttribute('width',w);r.setAttribute('height',h);
    r.setAttribute('rx',4);r.setAttribute('ry',4);
    r.setAttribute('fill','#161630');r.setAttribute('stroke','#818cf8');
    r.setAttribute('stroke-dasharray','4 2');
    r.classList.add('node-bg');g.appendChild(r);
    const lb=document.createElementNS(svgNS,'text');
    lb.setAttribute('x',n.x);lb.setAttribute('y',n.y-0.5);
    lb.classList.add('gate-label');lb.textContent=n.label;g.appendChild(lb);
    const sb=document.createElementNS(svgNS,'text');
    sb.setAttribute('x',n.x);sb.setAttribute('y',n.y+9);
    sb.classList.add('gate-sublabel');sb.textContent=n.label2;g.appendChild(sb);
  } else {
    const w=118,h=38;
    const r=document.createElementNS(svgNS,'rect');
    r.setAttribute('x',n.x-w/2);r.setAttribute('y',n.y-h/2);
    r.setAttribute('width',w);r.setAttribute('height',h);
    r.setAttribute('rx',6);r.setAttribute('ry',6);
    r.setAttribute('fill','#1a1a2e');r.setAttribute('stroke',n.color);
    r.classList.add('node-bg');g.appendChild(r);
    const ph=document.createElementNS(svgNS,'text');
    ph.setAttribute('x',n.x);ph.setAttribute('y',n.y-9);
    ph.setAttribute('fill',n.color);ph.classList.add('node-phase');
    ph.textContent=n.phase==='FT'?'FUTURE':n.phase;g.appendChild(ph);
    const lb=document.createElementNS(svgNS,'text');
    lb.setAttribute('x',n.x);lb.setAttribute('y',n.y+2);
    lb.classList.add('node-label');lb.textContent=n.label;g.appendChild(lb);
    const sb=document.createElementNS(svgNS,'text');
    sb.setAttribute('x',n.x);sb.setAttribute('y',n.y+12);
    sb.classList.add('node-sublabel');sb.textContent=n.label2;g.appendChild(sb);
  }
  g.addEventListener('click',e=>{e.stopPropagation();selectNode(n.id)});
  nodesG.appendChild(g);nodeEls[n.id]=g;
});

const panelEmpty=document.getElementById('panelEmpty');
const panelContent=document.getElementById('panelContent');
let selectedNode=null;
function selectNode(id){
  if(selectedNode===id){clearSelection();return}
  selectedNode=id;const n=nodeMap[id];
  const up=upstream[id],down=downstream[id];
  const conn=new Set([id,...up,...down]);
  Object.entries(nodeEls).forEach(([nid,el])=>{
    el.classList.remove('active','dimmed');
    if(nid===id)el.classList.add('active');
    else if(!conn.has(nid))el.classList.add('dimmed');
  });
  edgeEls.forEach(p=>{
    p.classList.remove('highlighted','dimmed');
    if(p.dataset.from===id||p.dataset.to===id)p.classList.add('highlighted');
    else p.classList.add('dimmed');
  });
  panelEmpty.style.display='none';panelContent.classList.add('visible');
  const phaseMap={'P0':'Phase 0 (Infra)','P1':'Phase 1','P2':'Phase 2','P3':'Phase 3','P2/3':'Phase 2/3 Boundary','FT':'Future'};
  document.getElementById('panelPhase').textContent=phaseMap[n.phase]||n.phase;
  document.getElementById('panelPhase').style.color=n.color;
  document.getElementById('panelTitle').textContent=n.label;
  document.getElementById('panelZh').textContent=n.label2;
  document.getElementById('panelDept').textContent=n.dept;
  const typeEl=document.getElementById('panelType');
  if(n.type==='infra'){typeEl.textContent='INFRASTRUCTURE';typeEl.className='panel-type type-infra';}
  else if(n.type==='gate'){typeEl.textContent='DECISION GATE';typeEl.className='panel-type type-gate';}
  else{typeEl.textContent='APPLICATION';typeEl.className='panel-type type-app';}
  document.getElementById('panelDesc').textContent=n.desc||'';
  document.getElementById('upCount').textContent=up.length;
  document.getElementById('downCount').textContent=down.length;
  document.getElementById('totalCount').textContent=totalReach(id);
  document.getElementById('upList').innerHTML=up.length
    ?up.map(uid=>`<li><span class="dot" style="background:${nodeMap[uid].color}"></span>${nodeMap[uid].label}</li>`).join('')
    :'<li class="panel-list-none">None (Root)</li>';
  document.getElementById('downList').innerHTML=down.length
    ?down.map(did=>`<li><span class="dot" style="background:${nodeMap[did].color}"></span>${nodeMap[did].label}</li>`).join('')
    :'<li class="panel-list-none">None (Terminal)</li>';
}
function clearSelection(){
  selectedNode=null;
  Object.values(nodeEls).forEach(el=>el.classList.remove('active','dimmed'));
  edgeEls.forEach(p=>p.classList.remove('highlighted','dimmed'));
  panelEmpty.style.display='flex';panelContent.classList.remove('visible');
}
document.querySelector('.dep-svg').addEventListener('click',()=>clearSelection());
</script>
</body>
</html>
